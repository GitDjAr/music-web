<!DOCTYPE html>
<html>

<head>
  <title>Audio Visualization</title>
</head>

<body>
  <button id="b">test</button>
  <input type="file" name="test" id="file">
  <canvas id="canvas" width="800" height="600"></canvas>
  <script>
    let b = document.getElementById('b')

    let input = document.getElementById('file')
    input.addEventListener('change', function () {
      if (this.files.length !== 0) {
        let file = this.files[0];
        let fr = new FileReader();
        fr.onload = function () {
          let fileRet = e.target.result;
          audioCtx.decodeAudioData(fileRet, function (buffer) {
            getBufferSuccess(buffer);
          }, function (err) {
            console.log(err)
          })
        }
        fr.readAsArrayBuffer(file);
      }
    })
    function getBufferSuccess(buffer) {

      // 获取canvas元素
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      // 设置渐变色
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, '#00f');
      gradient.addColorStop(0.5, '#0f0');
      gradient.addColorStop(1, '#f00');

      // 绘制音频可视化图形
      function draw() {
        requestAnimationFrame(draw);

        // 获取音频数据
        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(data);

        // 清空画布
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 绘制音频可视化图形
        for (let i = 0; i < data.length; i++) {
          const barWidth = canvas.width / data.length;
          const barHeight = data[i];
          ctx.fillStyle = gradient;
          ctx.fillRect(i * barWidth, canvas.height - barHeight, barWidth, barHeight);
        }
      }

      // 初始化音频分析器
      const context = new AudioContext();
      const analyser = context.createAnalyser();
      const source = context.createMediaElementSource(audio);

      source.buffer = buffer;
      analyser.connect(context.destination);
      audio.play()
      draw();
    }

    b.onclick = () => {
      // const audio = new Audio('http://m7.music.126.net/20221207092901/275cc3eee586e8df104798eb1b4f661a/ymusic/4fb1/aa51/eb23/ceeba5aaa4020710dec4035980443723.mp3')


      // 获取音频文件



    }
  </script>
</body>